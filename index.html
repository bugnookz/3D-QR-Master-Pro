<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D QR Master Pro (PromptPay Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --success: #10b981; --warning: #f59e0b; --purple: #8b5cf6; --blue: #3b82f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; color: #1e293b; }
        .card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 500px; }
        h2 { margin-top: 0; color: #334155; text-align: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #64748b; }
        select, input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
        select:focus, input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-gen:hover { background: #4f46e5; }
        .download-group { display: none; margin-top: 15px; border-top: 1px solid #f1f5f9; padding-top: 15px; }
        .btn-svg { background: var(--success); color: white; }
        .btn-jpg { background: var(--warning); color: white; }
        .btn-stl { background: var(--purple); color: white; }
        
        #svg-preview-area { margin-top: 20px; display: flex; flex-direction: column; align-items: center; border: 2px dashed #e2e8f0; border-radius: 12px; padding: 20px; background: #fff; min-height: 200px; justify-content: center; }
        #qrcode-hidden { display: none; }
        .hint { font-size: 12px; color: #94a3b8; margin-top: 10px; text-align: center; }
        
        /* PromptPay Style */
        .pp-header { background: #eef2ff; color: #1e3a8a; padding: 10px; border-radius: 8px; font-size: 0.9em; margin-bottom: 10px; border: 1px solid #c7d2fe; }
    </style>
</head>
<body>

<div class="card">
    <h2>3D QR Generator Pro</h2>
    
    <div class="form-group">
        <label>1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
        <select id="type-select" onchange="toggleFields()">
            <option value="text">üåê ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå / ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</option>
            <option value="promptpay">üí∞ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (PromptPay)</option>
            <option value="wifi">üì∂ ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Wi-Fi</option>
            <option value="vcard">üìá ‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ (vCard)</option>
        </select>
    </div>

    <div id="field-text" class="form-group">
        <label>Link ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
        <input type="text" id="input-text" placeholder="https://www.google.com">
    </div>

    <div id="field-promptpay" style="display:none;">
        <div class="pp-header">‚ÑπÔ∏è ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (08x...) ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)</div>
        <div class="form-group">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
            <input type="text" id="pp-id" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0812345678" maxlength="13">
        </div>
        <div class="form-group">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) *‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ</label>
            <input type="number" id="pp-amount" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 100.00" step="0.01">
        </div>
    </div>

    <div id="field-wifi" style="display:none;">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠ Wi-Fi (SSID)</label><input type="text" id="wifi-ssid"></div>
        <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="wifi-pass"></div>
        <div class="form-group">
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</label>
            <select id="wifi-enc"><option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">None</option></select>
        </div>
    </div>

    <div id="field-vcard" style="display:none;">
        <div class="grid">
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="vc-name"></div>
            <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="vc-tel"></div>
        </div>
        <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="vc-email"></div>
    </div>

    <button class="btn-gen" onclick="generate()">‚ö° ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
    
    <div id="svg-preview-area">
        <span id="preview-placeholder" style="color: #94a3b8;">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>
    </div>
    
    <div class="download-group" id="download-group">
        <button class="btn-stl" onclick="downloadSTL()">üßä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î .STL (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ QR Code)</button>
        <button class="btn-svg" onclick="downloadSVG()">üìÇ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î .SVG</button>
        <button class="btn-jpg" onclick="downloadJPG()">üñºÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î .JPG</button>
    </div>
    
    <div id="qrcode-hidden"></div>
    <canvas id="canvas-export" style="display:none;"></canvas>
    <p class="hint">* STL: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß QR (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô) ‡∏´‡∏ô‡∏≤ 1.2mm<br>‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ wasantakan </p>
</div>

<script>
    let qrMatrix = [];
    let qrSize = 0;

    function toggleFields() {
        const type = document.getElementById('type-select').value;
        document.getElementById('field-text').style.display = type === 'text' ? 'block' : 'none';
        document.getElementById('field-promptpay').style.display = type === 'promptpay' ? 'block' : 'none';
        document.getElementById('field-wifi').style.display = type === 'wifi' ? 'block' : 'none';
        document.getElementById('field-vcard').style.display = type === 'vcard' ? 'block' : 'none';
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PromptPay String ‡πÅ‡∏•‡∏∞ CRC16 ---
    function crc16(data) {
        let crc = 0xFFFF;
        for (let i = 0; i < data.length; i++) {
            let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xFF;
            x ^= x >> 4;
            crc = ((crc << 8) ^ (x << 12) ^ (x << 5) ^ x) & 0xFFFF;
        }
        return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    function generatePromptPayPayload(target, amount) {
        let targetSanitized = target.replace(/[^0-9]/g, '');
        let targetType = "";

        if (targetSanitized.length === 10 && targetSanitized.startsWith('0')) {
            targetType = "01"; // Phone
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 00 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ 66 (‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)
            targetSanitized = "0066" + targetSanitized.substring(1); 
        } else if (targetSanitized.length === 13) {
            targetType = "02"; // ID Card
        } else {
            alert("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return null;
        }

        const f = (id, val) => id + val.length.toString().padStart(2, '0') + val;
        
        // Build Payload
        let payload = "";
        payload += f("00", "01"); // Version
        payload += f("01", amount ? "12" : "11"); // Method (11=static, 12=amount)
        
        let merchantInfo = f("00", "A000000677010111") + f(targetType, targetSanitized);
        payload += f("29", merchantInfo);
        
        payload += f("53", "764"); // Currency THB
        payload += f("58", "TH");  // Country

        if (amount) {
            payload += f("54", parseFloat(amount).toFixed(2));
        }

        payload += "6304"; // Checksum ID + Length
        payload += crc16(payload); // Append calculated CRC

        return payload;
    }
    // ----------------------------------------------------

    function generate() {
        const type = document.getElementById('type-select').value;
        let finalData = "";

        if(type === 'text') {
            finalData = document.getElementById('input-text').value;
        } 
        else if (type === 'promptpay') {
            const ppId = document.getElementById('pp-id').value;
            const ppAmount = document.getElementById('pp-amount').value;
            if(!ppId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô");
            finalData = generatePromptPayPayload(ppId, ppAmount);
            if(!finalData) return; // Error in promptpay gen
        }
        else if(type === 'wifi') {
            finalData = `WIFI:S:${document.getElementById('wifi-ssid').value || "WiFi"};T:${document.getElementById('wifi-enc').value};P:${document.getElementById('wifi-pass').value || ""};;`;
        } 
        else if(type === 'vcard') {
            finalData = `BEGIN:VCARD\nVERSION:3.0\nN:${document.getElementById('vc-name').value || "User"}\nTEL:${document.getElementById('vc-tel').value || ""}\nEMAIL:${document.getElementById('vc-email').value || ""}\nEND:VCARD`;
        }

        if(!finalData) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

        const hidden = document.getElementById('qrcode-hidden');
        hidden.innerHTML = "";
        
        const qrObj = new QRCode(hidden, {
            text: finalData,
            width: 256,
            height: 256,
            correctLevel: QRCode.CorrectLevel.M 
        });

        setTimeout(() => {
            qrSize = qrObj._oQRCode.getModuleCount();
            qrMatrix = [];
            for (let r = 0; r < qrSize; r++) {
                qrMatrix[r] = [];
                for (let c = 0; c < qrSize; c++) {
                    qrMatrix[r][c] = qrObj._oQRCode.isDark(r, c);
                }
            }

            const svgSize = 1000;
            const cellSize = svgSize / qrSize;
            let pathData = "";

            for (let row = 0; row < qrSize; row++) {
                for (let col = 0; col < qrSize; col++) {
                    if (qrMatrix[row][col]) {
                        const x = col * cellSize;
                        const y = row * cellSize;
                        pathData += `M${x.toFixed(2)},${y.toFixed(2)} h${cellSize.toFixed(2)} v${cellSize.toFixed(2)} h-${cellSize.toFixed(2)} z `;
                    }
                }
            }

            const svgFinal = `<svg id="main-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${svgSize} ${svgSize}" width="250" height="250">
                <rect width="${svgSize}" height="${svgSize}" fill="white"/>
                <path d="${pathData}" fill="black"/>
            </svg>`;

            document.getElementById('svg-preview-area').innerHTML = svgFinal;
            document.getElementById('download-group').style.display = 'block';
        }, 100);
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á STL (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function downloadSTL() {
        if (qrMatrix.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏Å‡πà‡∏≠‡∏ô");

        const scale = 2.0;         
        const thickness = 1.2;     
        
        const makeFacet = (v1, v2, v3) => {
            return `  facet normal 0 0 0\n    outer loop\n      vertex ${v1}\n      vertex ${v2}\n      vertex ${v3}\n    endloop\n  endfacet\n`;
        };

        const createBoxString = (x, y, zStart, zEnd, w, h) => {
            const x1 = (x * scale).toFixed(3);
            const x2 = ((x + w) * scale).toFixed(3);
            const y1 = (y * scale).toFixed(3);
            const y2 = ((y + h) * scale).toFixed(3);
            const z1 = zStart.toFixed(3);
            const z2 = zEnd.toFixed(3);

            const p1=`${x1} ${y1} ${z1}`, p2=`${x2} ${y1} ${z1}`, p3=`${x2} ${y2} ${z1}`, p4=`${x1} ${y2} ${z1}`;
            const p5=`${x1} ${y1} ${z2}`, p6=`${x2} ${y1} ${z2}`, p7=`${x2} ${y2} ${z2}`, p8=`${x1} ${y2} ${z2}`;

            let s = "";
            s += makeFacet(p1, p2, p3) + makeFacet(p1, p3, p4); 
            s += makeFacet(p5, p7, p6) + makeFacet(p5, p8, p7); 
            s += makeFacet(p1, p5, p2) + makeFacet(p2, p5, p6); 
            s += makeFacet(p2, p6, p3) + makeFacet(p3, p6, p7); 
            s += makeFacet(p3, p7, p4) + makeFacet(p4, p7, p8); 
            s += makeFacet(p4, p8, p1) + makeFacet(p1, p8, p5); 
            return s;
        };

        let stlContent = "solid QRCode\n";

        for (let r = 0; r < qrSize; r++) {
            for (let c = 0; c < qrSize; c++) {
                if (qrMatrix[r][c]) {
                    stlContent += createBoxString(c, (qrSize - 1 - r), 0, thickness, 1, 1);
                }
            }
        }
        
        stlContent += "endsolid QRCode\n";

        const blob = new Blob([stlContent], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "QR_Progen.stl";
        a.click();
    }

    function downloadSVG() {
        const svgData = document.getElementById('main-svg').outerHTML;
        const blob = new Blob([svgData], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `3D-QR-PromptPay.svg`;
        a.click();
    }

    function downloadJPG() {
        const svgElement = document.getElementById('main-svg');
        const canvas = document.getElementById('canvas-export');
        const ctx = canvas.getContext('2d');
        canvas.width = 2000;
        canvas.height = 2000;

        const svgData = new XMLSerializer().serializeToString(svgElement);
        const img = new Image();
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);

        img.onload = function() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const jpgUrl = canvas.toDataURL("image/jpeg", 0.9);
            const a = document.createElement('a');
            a.href = jpgUrl;
            a.download = `QR-PromptPay.jpg`;
            a.click();
            URL.revokeObjectURL(url);
        };
        img.src = url;
    }
</script>

</body>
</html>
